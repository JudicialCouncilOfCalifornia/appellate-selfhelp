<?php

	function mo_mmp_showScanResults(){
		$mo_wpns_db_handler = new MowafDB();
		if(isset($_GET['view'])){
			if(isset($_GET['trust'])){
				$mo_wpns_db_handler->ignorefile(base64_decode(sanitize_text_field($_GET['trust'])));
			}
			elseif(isset($_GET['trustchanged'])){
				$mo_wpns_db_handler->ignorechangedfile(sanitize_text_field($_GET['trustchanged']));
			}
			$last_id=$mo_wpns_db_handler->get_last_id();
			$send_id=$last_id[0]->max;
			$last_scan=$mo_wpns_db_handler->count_files_last_scan($send_id);
			$listofignorefiles = $mo_wpns_db_handler->getlistofignorefiles();
			$ignorefiles = array();
			foreach($listofignorefiles as $row)
				$ignorefiles[$row->path] = array('signature'=>$row->signature,"id"=>$row->id);

			$result = $mo_wpns_db_handler->get_report_with_id(sanitize_text_field($_GET['view']));
			if(sizeof($result)>0){
				$detailreport = $mo_wpns_db_handler->get_detail_report_with_id(sanitize_text_field($_GET['view']));
				mo_mmp_show_scan_details($detailreport, $result, $ignorefiles, $last_scan);
			}
		}
		else{
			$str1= sanitize_text_field($_SERVER['REQUEST_URI']);
			$str1= str_replace("admin-ajax.php", "admin.php?page=mo_mmp_malwarescan", $str1);
			$currenturl = remove_query_arg('delete',$str1);
			$currenturl = remove_query_arg('view',$currenturl);
			$currenturl = remove_query_arg('trust',$currenturl);
			$currenturl = remove_query_arg('trustchanged',$currenturl);
			if(isset($_GET['delete'])){
				$mo_wpns_db_handler->delete_report(sanitize_text_field($_GET['delete']));
			}
			$result = $mo_wpns_db_handler->get_report();
			mo_mmp_show_scan_report($currenturl, $result);
		}
	}

?>